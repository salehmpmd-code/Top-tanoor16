<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پنل مدیریت</title>
  <style>
    body { font-family: 'Tahoma', sans-serif; margin:0; padding:0; background:#f0f2f5; color:#333; }
    header { background:#007BFF; color:#fff; padding:10px 20px; text-align:center; font-size:20px; }
    section { padding:15px; }
    input, select, textarea { width:100%; padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:5px; }
    button { padding:8px 12px; border:none; border-radius:5px; background:#007BFF; color:#fff; cursor:pointer; margin-top:5px; }
    button.delete { background:#dc3545; }
    .card { background:#fff; padding:10px; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .flex { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .flex input { flex:1; }
  </style>
</head>
<body>
  <header>پنل مدیریت</header>

  <section id="loginSection">
    <h2>ورود مدیر</h2>
    <input type="text" id="username" placeholder="نام کاربری">
    <input type="password" id="password" placeholder="رمز عبور">
    <button onclick="login()">ورود</button>
    <div id="loginMsg" style="color:red;"></div>
  </section>

  <section id="mainPanel" style="display:none;">
    <h2>تنظیمات سایت</h2>
    <input type="text" id="siteTitleInput" placeholder="عنوان سایت">
    <input type="text" id="subtitleInput" placeholder="زیرعنوان">
    <textarea id="aboutTextInput" placeholder="درباره سایت"></textarea>
    <button onclick="saveSettings()">ذخیره تنظیمات</button>

    <h2>تصاویر هدر</h2>
    <input type="file" id="headerFile">
    <button onclick="uploadHeader()">آپلود تصویر</button>
    <div id="heroList"></div>

    <h2>آیتم‌ها</h2>
    <div class="card">
      <input type="text" id="newName" placeholder="نام آیتم">
      <textarea id="newDesc" placeholder="توضیحات"></textarea>
      <input type="number" id="newPrice" placeholder="قیمت">
      <input type="text" id="newImage" placeholder="آدرس تصویر">
      <input type="text" id="newSection" placeholder="دسته‌بندی">
      <button onclick="addItem()">افزودن آیتم</button>
    </div>
    <div id="itemCards"></div>
  </section>

<script>
let token = localStorage.getItem('jwt') || '';

async function login() {
  const res = await fetch('/api/auth/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: qs('#username').value, password: qs('#password').value })
  });
  if(res.ok){
    const data = await res.json();
    token = data.token;
    localStorage.setItem('jwt', token);
    document.getElementById('loginSection').style.display='none';
    document.getElementById('mainPanel').style.display='block';
    loadSettings();
    loadItems();
  } else {
    document.getElementById('loginMsg').textContent='خطا در ورود';
  }
}

function qs(id){ return document.getElementById(id); }

async function fetchWithAuth(url, options={}) {
  options.headers = options.headers || {};
  options.headers['Authorization'] = 'Bearer '+token;
  return fetch(url, options);
}

// Settings
async function loadSettings(){
  const res = await fetch('/api/settings');
  if(res.ok){
    const s = await res.json();
    qs('siteTitleInput').value = s.siteTitle || '';
    qs('subtitleInput').value = s.subtitle || '';
    qs('aboutTextInput').value = s.aboutText || '';
    renderHeroList(s.heroImages || []);
  }
}

async function saveSettings(){
  const res = await fetchWithAuth('/api/settings', {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      siteTitle: qs('siteTitleInput').value,
      subtitle: qs('subtitleInput').value,
      aboutText: qs('aboutTextInput').value
    })
  });
  if(res.ok) alert('ذخیره شد');
}

// Hero
function renderHeroList(images){
  const container = qs('heroList');
  container.innerHTML='';
  images.forEach((url,i)=>{
    const div=document.createElement('div');
    div.className='flex card';
    div.innerHTML=`<span>${url}</span><button class="delete" onclick="deleteHero('${url}')">حذف</button>`;
    container.appendChild(div);
  });
}

async function uploadHeader(){
  const file = qs('headerFile').files[0];
  if(!file) return alert('فایل انتخاب نشده');
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetchWithAuth('/api/upload', { method:'POST', body: fd });
  if(res.ok){
    alert('آپلود شد');
    loadSettings();
  }
}

async function deleteHero(url){
  if(!confirm('مطمئن هستید؟')) return;
  const res = await fetchWithAuth('/api/upload', {
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ url })
  });
  if(res.ok) loadSettings();
}

// Items
async function loadItems(){
  const res = await fetchWithAuth('/api/items');
  if(res.ok){
    const items = await res.json();
    const container = qs('itemCards');
    container.innerHTML='';
    items.forEach(item=>{
      const div=document.createElement('div');
      div.className='card flex';
      div.innerHTML=`
        <input value="${item.name}" onchange="updateItem('${item._id}', this.value, null,null,null,null)">
        <input value="${item.description}" onchange="updateItem('${item._id}', null, this.value,null,null,null)">
        <input type="number" value="${item.price}" onchange="updateItem('${item._id}', null,null,Number(this.value),null,null)">
        <input value="${item.image}" onchange="updateItem('${item._id}', null,null,null,this.value,null)">
        <input value="${item.section}" onchange="updateItem('${item._id}', null,null,null,null,this.value)">
        <button class="delete" onclick="removeItem('${item._id}')">حذف</button>
      `;
      container.appendChild(div);
    });
  }
}

async function addItem(){
  const name = qs('newName').value.trim();
  const desc = qs('newDesc').value.trim();
  const price = Number(qs('newPrice').value) || 0;
  const image = qs('newImage').value.trim();
  const section = qs('newSection').value.trim();
  const res = await fetchWithAuth('/api/items',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ name, description:desc, price, image, section })
  });
  if(res.ok){ loadItems(); qs('newName').value=''; qs('newDesc').value=''; qs('newPrice').value=''; qs('newImage').value=''; qs('newSection').value=''; }
}

async function updateItem(id,name,desc,price,image,section){
  const payload = {};
  if(name!==null) payload.name=name;
  if(desc!==null) payload.description=desc;
  if(price!==null) payload.price=price;
  if(image!==null) payload.image=image;
  if(section!==null) payload.section=section;
  await fetchWithAuth('/api/items/'+id,{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
}

async function removeItem(id){
  if(!confirm('آیا مطمئن هستید؟')) return;
  await fetchWithAuth('/api/items/'+id,{ method:'DELETE' });
  loadItems();
}
</script>
</body>
</html>
